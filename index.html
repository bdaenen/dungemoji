<!doctype html><meta charset="utf-8"><style type="text/css">*{margin:0;padding:0;color:#aaa}body{position:relative}html{height:100%}.emo,canvas,table{color:red;font-size:3em;font-family:'Segoe Ui Emoji',sans-serif}table{table-layout:fixed;width:960px;height:400px;border:5px solid green;text-align:center;border-collapse:collapse;background-color:#633f19;margin:0 auto}.emo,canvas{margin:0}.enemy table{border:5px solid red}table:first-of-type tr:last-child td{border-bottom:0}#p tr:first-child td{border-top:0}.a,tr{width:100%}td,tr{height:33%}td{border:10px solid rgba(123,77,29,.4);width:33%;position:relative}li,ul{list-style:none;margin:0;padding:0}.a{display:none;top:0;bottom:0;position:absolute;background-color:rgba(0,0,0,.5);z-index:1}.a li,.turn{font-size:40px}.a li{display:inline-block;height:80px;width:80px;vertical-align:middle;line-height:80px;position:relative;top:30px}.a li:after{top:-5px;left:0;content:'‚óº';position:absolute;z-index:-1;font-size:100px;width:80px;height:85px}.valid{background:rgba(0,200,0,.3)}td .a{display:block}.turn{position:absolute;right:0;top:55%;transform:translate(-50%,-50%);background:rgba(0,0,0,.8);padding:20px;color:green}.enemy .turn{top:45%;bottom:auto;color:red}.a li[data-action-id=endTurn]:before{content:'';position:absolute;top:25px;bottom:40px;width:auto;background:#0078d7;left:20px;right:22px}.health,.view{pointer-events:none}.health{font-size:20px}.view{opacity:1}.view.hasActed{opacity:.5}.noRange{filter:grayscale(100%) brightness(40%) sepia(100%) hue-rotate(-50deg) saturate(600%) contrast(.8)}</style><div id="m"><ul class="a"></ul><table id="e"><tr id="e-b"><td id="e-b-l"></td><td id="e-b-c"></td><td id="e-b-r"></td></tr><tr id="e-m"><td id="e-m-l"></td><td id="e-m-c"></td><td id="e-m-r"></td></tr><tr id="e-f"><td id="e-f-l"></td><td id="e-f-c"></td><td id="e-f-r"></td></tr></table><table id="p"><tr id="p-f"><td id="p-f-l"></td><td id="p-f-c"></td><td id="p-f-r"></td></tr><tr id="p-m"><td id="p-m-l"></td><td id="p-m-c"></td><td id="p-m-r"></td></tr><tr id="p-b"><td id="p-b-l"></td><td id="p-b-c"></td><td id="p-b-r"></td></tr></table></div><div class="turn">Player Turn</div><script>window.$=document.querySelector.bind(document),window.$$=document.querySelectorAll.bind(document),window.find=function(e,n){return e.querySelectorAll(n)}</script><script>!function(){"use strict";var t=function(t){this.stage=t,this.position={x:0,y:0},this.str=1,this.dex=10,this.int=10,this._sta=5,this.maxHealth=this._sta,this._health=this._sta,this.type=t.TYPE_PLAYER,this.view="üë¶ü§µüèª",this.$field=null,this.$view=null,this.currentAction=null,this.rotate=0,this._hasAttacked=!1,this._hasMoved=!1,this._hasActed=!1,this._alive=!0,this.actions=[{actionId:"move",view:"üèÉ",range:1,type:t.TYPE_PLAYER},{actionId:"attack",view:"üó°",range:1,rangeX:0,type:t.TYPE_ENEMY},{actionId:"endTurn",view:"üîö",type:t.TYPE_PLAYER}]};t.prototype={move:function(t,i){return t instanceof Node?this.move(+t.dataset.x,+t.dataset.y):this.stage.getPlayerInField(this.stage.getFieldByCoordinate(t,i))?(console.warn("cant move to occupied field"),!1):(this.position.x=t,this.position.y=i,this.stage.dirty=!0,void(this.playerTarget?console.log(this.view,"moves towards",this.playerTarget.view):console.log(this.view,"moves")))},attack:function(t){if(t){var i=this.stage.getPlayerInField(t),e=1;console.log(this.view,"attacks",i.view),Math.random()>i.dex/100?(Math.random()<this.dex/150&&(e=2)&&console.log("Critical hit!"),console.log(i.view,"receives",2*this.str*e,"damage"),i.health-=2*this.str*e):console.log(i.view,"dodged!")}},selectAction:function(t){this.currentAction=this.actions.filter(function(i){return i.actionId===t})[0],this.currentAction.range?(this.hideValidActionTargets(),this.renderValidActionTargets(this.currentAction),this.stage.state=this.stage.GAME_STATE_SELECT_TARGET):this.performSelectedAction()},performSelectedAction:function(t){this.stage.hideSelectAction(),this[this.currentAction.actionId](t),"move"===this.currentAction.actionId?this.hasMoved=!0:"attack"===this.currentAction.actionId?this.hasAttacked=!0:"endTurn"===this.currentAction.actionId&&this.endTurn(),this.hideValidActionTargets(),this.stage.dirty=!0},endTurn:function(){this.stage.turn===this.type&&(this.hasActed=!0,this.stage.endTurn())},getValidActionTargets:function(t){var i,e,s,n,a;if(t.type===this.stage.TYPE_PLAYER){for(i=this.type===this.stage.TYPE_PLAYER?this.stage.getPlayerFieldByCoordinate.bind(this.stage):this.stage.getEnemyFieldByCoordinate.bind(this.stage),e=this.position.x,s=this.position.y,n=[],a=1;a<=t.range;a++)n=n.concat([i(e+a,s),i(e-a,s),i(e,s+a),i(e,s-a)]);n=n.filter(function(t){return t&&!find(t,".view").length})}if(t.type===this.stage.TYPE_ENEMY){for(i=this.type===this.stage.TYPE_PLAYER?this.stage.getEnemyFieldByCoordinate.bind(this.stage):this.stage.getPlayerFieldByCoordinate.bind(this.stage),e=this.position.x,s=this.position.y,n=[],a=1;a<=t.range;a++)n=n.concat([i(e+a,s),i(e-a,s),i(e,s+a),i(e,s-a)]);n=n.filter(function(t){return t})}return n},renderValidActionTargets:function(t){var i=this.getValidActionTargets(t);return i.forEach(function(t){t.classList.add("valid")}),i},hideValidActionTargets:function(){$$(".valid").forEach(function(t){t.classList.remove("valid")})},render:function(t){var i=document.createElement("div");i.innerText=this.view,i.classList.add("view"),i.style.transform="rotate("+this.rotate+"deg)",t.appendChild(i),this.hasActed&&i.classList.add("hasActed"),this.$view=i,this.$field=t;var e=document.createElement("div");e.classList.add("health");for(var s=this.health;s>0;s--)e.innerText+="‚ù§";this.$field.appendChild(e)},renderActions:function(){var t=document.createElement("b");return this.actions.forEach(function(i){var e=document.createElement("li");if(!("move"===i.actionId&&this.hasMoved||"attack"===i.actionId&&this.hasAttacked)){var s=this.getValidActionTargets(i);"endTurn"===i.actionId||s&&s.length||e.classList.add("noRange"),e.innerText=i.view,e.dataset.actionId=i.actionId,t.appendChild(e)}},this),t.innerHTML},inAttackRange:function(t){var i=this.actions.filter(function(t){return"attack"===t.actionId})[0];return Math.abs(t.position.y-this.position.y)<=i.range&&Math.abs(t.position.x-this.position.x)<=i.rangeX},getClosest:function(t){var i=1/0,e=null;return t===this.stage.TYPE_PLAYER&&this.stage.players.forEach(function(t){var s=Math.abs(t.position.x-this.position.x)+Math.abs(t.position.y-this.position.y);s<i&&(i=s,e=t)},this),e},kill:function(){console.log(this.view,"was slain!"),this._alive=!1,this.stage.removeActor(this),this.stage=null,this.position=null,this.str=null,this.dex=null,this.int=null,this._sta=null,this.maxHealth=null,this._health=null,this.type=null,this.view=null,this.$field=null,this.$view=null,this.currentAction=null,this.rotate=null,this._hasAttacked=null,this._hasMoved=null,this._hasActed=null,this.actions=null}},Object.defineProperty(t.prototype,"sta",{get:function(){return this._sta},set:function(t){this._sta=t,this.maxHealth=this._sta,this.health>this.maxHealth&&(this.health=this.maxHealth)}}),Object.defineProperty(t.prototype,"health",{get:function(){return this._health},set:function(t){this._health=t,this.health>this.maxHealth&&(this._health=this.maxHealth),this.health<=0&&this.kill()}}),Object.defineProperty(t.prototype,"hasActed",{get:function(){return this._hasActed},set:function(t){this._hasActed=t,this._hasAttacked=t,this._hasMoved=t}}),Object.defineProperty(t.prototype,"hasMoved",{get:function(){return this._hasMoved},set:function(t){t!==this._hasMoved&&(this._hasMoved=t,this._hasMoved&&this._hasAttacked&&!this.hasActed?this.hasActed=!0:t||(this._hasActed=!1))}}),Object.defineProperty(t.prototype,"hasAttacked",{get:function(){return this._hasAttacked},set:function(t){t!==this._hasAttacked&&(this._hasAttacked=t,this._hasMoved&&this._hasAttacked&&!this.hasActed?this.hasActed=!0:t||(this._hasActed=!1))}}),Object.defineProperty(t.prototype,"alive",{get:function(){return this._alive}}),window.Player=t}()</script><script>!function(){"use strict";var t=function(t){Player.call(this,t),this.type=t.TYPE_ENEMY,this.view="ü¶Ç",this.playerTarget=null};(t.prototype=Object.create(Player.prototype)).constructor=t,t.prototype.determineTarget=function(){return this.playerTarget=null,this.stage.players.forEach(function(t){this.playerTarget||this.inAttackRange(t)&&(this.playerTarget=t)},this),this.playerTarget||(this.playerTarget=this.getClosest(this.stage.TYPE_PLAYER)),console.log(this.view,"targets",this.playerTarget.view),this},t.prototype.determineAction=function(){if(this.playerTarget&&this.playerTarget.alive||this.determineTarget(),this.inAttackRange(this.playerTarget)&&!this.hasAttacked)this.selectAction("attack"),this.performSelectedAction(this.playerTarget.$field);else{if(this.hasMoved)return void this.selectAction("endTurn");var t=this.position.x,e=this.position.y,i=t-this.playerTarget.position.x,s=null;2-e>0?s=this.stage.getEnemyFieldByCoordinate(t,e+1):i>0?s=this.stage.getEnemyFieldByCoordinate(t-1,e):i<0&&(s=this.stage.getEnemyFieldByCoordinate(t+1,e)),s?(this.selectAction("move"),this.performSelectedAction(s)):this.hasMoved=!0}this.stage.state=this.stage.GAME_STATE_AI_BUSY},window.Enemy=t}()</script><script>!function(){"use strict";var t=function(t){Enemy.call(this,t),this.view="ü¶Ç"};(t.prototype=Object.create(Enemy.prototype)).constructor=t,window.Scorpion=t}()</script><script>!function(){"use strict";var t=function(t){Enemy.call(this,t),this.type=t.TYPE_ENEMY,this.view="üï∑",this.rotate=180};(t.prototype=Object.create(Enemy.prototype)).constructor=t,window.Spider=t}()</script><script>!function(){"use strict";var e=function(){this.renderTargets=[],this.dirty=!1,this._state=this.GAME_STATE_SELECT_CHARACTER,this._turn="",this.turn=this.TYPE_PLAYER,this.currentSelection=null};e.prototype={GAME_STATE_SELECT_CHARACTER:1,GAME_STATE_SELECT_ACTION:2,GAME_STATE_SELECT_TARGET:3,GAME_STATE_AI_BUSY:4,TYPE_PLAYER:1,TYPE_ENEMY:2,init:function(){},addActor:function(e){this.renderTargets.push(e),this.dirty=!0},removeActor:function(e){var t=this.renderTargets.indexOf(e);-1!==t&&this.renderTargets.splice(t,1),this.dirty=!0},render:function(){mappedStage.forEach(function(e){e.forEach(function(e){e.innerText=""})}),this.renderTargets.forEach(function(e){var t=this.getFieldByCoordinate(e.position.x,e.position.y);e.render(t)},this),this.dirty=!1},getFieldByCoordinate:function(e,t,i){switch(i){case FIELD_TYPE_ENEMY:return mappedEnemyFields[t]&&mappedEnemyFields[t][e];case FIELD_TYPE_PLAYER:return mappedPlayerFields[t]&&mappedPlayerFields[t][e];case FIELD_TYPE_STAGE:default:return mappedStage[t]&&mappedStage[t][e]}},getPlayerFieldByCoordinate:function(e,t,i){if(t>2)return this.getFieldByCoordinate(e,t,i)},getEnemyFieldByCoordinate:function(e,t,i){if(t<=2)return this.getFieldByCoordinate(e,t,i)},getPlayerInField:function(e,t,i){var n=null;return(t?t===this.TYPE_PLAYER?i?this.playersToAct:this.players:this.enemiesToAct:this.renderTargets).forEach(function(t){t.$field&&t.$field.id===e.id&&(n=t)}),n},updateAi:function(){this.state=this.GAME_STATE_AI_BUSY;var e=this.enemiesToAct.shift();if(!e)return this.endTurn();e.determineTarget(),function(e){setTimeout(function(){this.state===this.GAME_STATE_AI_BUSY&&e.determineAction()}.bind(this),1e3),setTimeout(function(){this.state===this.GAME_STATE_AI_BUSY&&e.determineAction()}.bind(this),2e3),setTimeout(function(){this.state===this.GAME_STATE_AI_BUSY&&e.determineAction()}.bind(this),3e3)}.bind(this)(e)},renderSelectAction:function(){setTimeout(function(){$(".a").innerHTML=this.currentSelection.renderActions(),this.currentSelection.$field.appendChild($(".a"))}.bind(this),100)},hideSelectAction:function(){$(".a").innerHTML="",$("#m").appendChild($(".a"))},endTurn:function(){this.enemiesToAct.length||this.playersToAct.length?console.log("--- END OF TURN ---"):(console.log("--- END OF ROUND ---"),this.renderTargets.forEach(function(e){e.hasActed=!1},this)),this.turn=this.turn===this.TYPE_ENEMY?this.TYPE_PLAYER:this.TYPE_ENEMY,this.state=this.GAME_STATE_SELECT_CHARACTER}},Object.defineProperty(e.prototype,"state",{get:function(){return this._state},set:function(e){this._state=e,e===this.GAME_STATE_SELECT_ACTION?this.renderSelectAction():e!==this.GAME_STATE_SELECT_TARGET&&this.hideSelectAction()}}),Object.defineProperty(e.prototype,"turn",{get:function(){return this._turn},set:function(e){var t=$(".turn"),i=$("html").classList;this._turn=e,e===this.TYPE_ENEMY?(t.innerText="Enemy",i.add("enemy")):(t.innerText="Player",i.remove("enemy")),e===this.TYPE_ENEMY?(t.innerText="Enemy")&&i.add("enemy"):(t.innerText="Player")&&i.remove("enemy"),t.innerText+=" Turn",this.dirty=!0}}),Object.defineProperty(e.prototype,"enemies",{get:function(){return this.renderTargets.filter(function(e){return e.type===this.TYPE_ENEMY},this)}}),Object.defineProperty(e.prototype,"players",{get:function(){return this.renderTargets.filter(function(e){return e.type===this.TYPE_PLAYER},this)}}),Object.defineProperty(e.prototype,"enemiesToAct",{get:function(){return this.renderTargets.filter(function(e){return e.type===this.TYPE_ENEMY&&!e.hasActed},this)}}),Object.defineProperty(e.prototype,"playersToAct",{get:function(){return this.renderTargets.filter(function(e){return e.type===this.TYPE_PLAYER&&!e.hasActed},this)}}),window.mappedEnemyFields=[[$("#e-b-l"),$("#e-b-c"),$("#e-b-r")],[$("#e-m-l"),$("#e-m-c"),$("#e-m-r")],[$("#e-f-l"),$("#e-f-c"),$("#e-f-r")]],window.mappedPlayerFields=[[$("#p-f-l"),$("#p-f-c"),$("#p-f-r")],[$("#p-m-l"),$("#p-m-c"),$("#p-m-r")],[$("#p-b-l"),$("#p-b-c"),$("#p-b-r")]],window.mappedStage=mappedEnemyFields.concat(mappedPlayerFields);var t=0,i=0;mappedStage.forEach(function(e){e.forEach(function(e){e.dataset.x=t,e.dataset.y=i,t++}),i++,t=0}),window.FIELD_TYPE_PLAYER=1,window.FIELD_TYPE_ENEMY=2,window.FIELD_TYPE_STAGE=3,window.Stage=e}()</script><script>!function(){"use strict";function t(t,i,o,r){var e=new Player(t);return e.move(i,o),e.view=r,e}function i(t,i,o,r){var e=new window[r](t);return e.move(i,o),e}var o=function(){Stage.call(this)};(o.prototype=Object.create(Stage.prototype)).constructor=o,o.prototype.init=function(){this.addActor(t(this,0,5,"üßôüèª‚Äç‚ôÇ")),this.addActor(t(this,0,4,"üßùüèº")),this.addActor(t(this,0,3,"üò°")),this.addActor(i(this,1,2,"Scorpion"));var o=i(this,0,2,"Spider");this.addActor(o),this.turn=this.TYPE_PLAYER,console.clear()},window.Stage1=o}()</script><script>!function(){"use strict";function e(n){if(t.turn===t.TYPE_PLAYER){var r=n.target;if(t.state===t.GAME_STATE_SELECT_CHARACTER)t.currentSelection=t.getPlayerInField(r,t.TYPE_PLAYER,!0),t.currentSelection&&(t.state=t.GAME_STATE_SELECT_ACTION);else if(t.state===t.GAME_STATE_SELECT_ACTION){var c;(c=r.dataset.actionId)?(t.currentSelection.selectAction(c),n.stopPropagation()):t.currentSelection.hasMoved||t.currentSelection.hasAttacked||!t.getPlayerInField(r,t.TYPE_PLAYER,!0)||(t.currentSelection=t.getPlayerInField(r,t.TYPE_PLAYER,!0),t.state=t.GAME_STATE_SELECT_ACTION)}else t.state===t.GAME_STATE_SELECT_TARGET&&(r.classList.contains("valid")?(t.currentSelection.performSelectedAction(n.target),t.currentSelection.hasMoved&&t.currentSelection.hasAttacked?t.currentSelection.currentAction&&"endTurn"===t.currentSelection.currentAction.actionId||t.currentSelection.endTurn():(t.state=t.GAME_STATE_SELECT_ACTION,e(n))):(c=r.dataset.actionId)&&t.currentSelection.selectAction(c))}}var t=null,n=document.createElement("canvas"),r=n.getContext("2d");n.width=n.height=55,r.font='72px "Segoe Ui Emoji"',r.fillText("‚¨õ",-9,53),$("#m").style.backgroundImage='url("'+n.toDataURL()+'")';var c=new Stage1;t=c,c.init();var a=function(){t.turn===t.TYPE_ENEMY&&t.state!==t.GAME_STATE_AI_BUSY&&t.updateAi(),t.dirty&&t.render(),requestAnimationFrame(a)};a(),mappedStage.forEach(function(t){t.forEach(function(t){t.addEventListener("click",e)})})}()</script>